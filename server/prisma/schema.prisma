generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            Int              @id @default(autoincrement())
  login         String           @unique
  password      String
  createdAt     DateTime         @default(now())
  refreshToken  RefreshToken?
  participations GameParticipant[]
}

model RefreshToken {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GameType {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  minPlayers  Int
  maxPlayers  Int?
  description String?
  games       Game[]
}

model Game {
  id           String                @id @default(uuid())
  gameTypeId   Int
  status       String             @default("active")
  startedAt    DateTime           @default(now())
  finishedAt   DateTime?
  gameType     GameType           @relation(fields: [gameTypeId], references: [id], onDelete: Restrict)
  participants GameParticipant[]
  checkersGame CheckersGame?
  chessGame    ChessGame?
}

model GameParticipant {
  id          Int      @id @default(autoincrement())
  gameId      String
  playerId    Int
  joinedAt    DateTime @default(now())
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player      User     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  colorParticipant GameWithColorParticipant?

  @@index([gameId])
  @@index([playerId])
  @@unique([gameId, playerId])
}

model GameWithColorParticipant {
  id            Int             @id @default(autoincrement())
  color         String
  participantId Int             @unique
  participant   GameParticipant @relation(fields: [participantId], references: [id])
}

model CheckersGame {
  id          Int      @id @default(autoincrement())
  gameId      String      @unique
  figures     String   @default("[]")
  currentTurn String?   // Можно заменить на Int, если currentTurn должен быть id пользователя
  moveCount   Int      @default(0)
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model ChessGame {
  id      Int   @id @default(autoincrement())
  gameId  String   @unique
  game    Game  @relation(fields: [gameId], references: [id], onDelete: Cascade)
}
